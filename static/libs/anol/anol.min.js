/**
 * @name anol
 * @version 0.0.1
 * @description
 * Framework to create a cool map with AngularJS, Bootstrap and OpenLayers3
 * Created at 2014-12-10
 * Revision 
 */
angular.module("anol",[]).constant("DefaultMapName","anol-map").filter("html",["$sce",function(a){return function(b){return a.trustAsHtml(b)}}]),angular.module("anol.featurepopup",["anol.map"]),angular.module("anol.layerswitcher",["anol.map"]),angular.module("anol.map",["anol"]),angular.module("anol.mouseposition",["anol.map"]),angular.module("anol.permalink",["anol.map"]),angular.module("anol.print",["anol.map"]),angular.module("anol.scale",["anol.map"]),angular.module("anol.featurepopup").directive("anolFeaturePopup",["$timeout","MapService",function(a,b){return{restrict:"A",scope:{featureLayer:"@featureLayer"},replace:!0,templateUrl:"src/modules/featurepopup/templates/popup.html",link:{pre:function(c,d){c.map=b.getMap(),c.feature=void 0,c.popupVisible=!1,c.overlayOptions={element:d[0]},c.handleClick=function(b){var d=!1,e=c.map.forEachFeatureAtPixel(b.pixel,function(a,b){return b.get("layer")===c.featureLayer?a:void 0});e&&(c.popup.setPosition(b.coordinate),d=!0,a(function(){var a=c.calculatePopupExtent(b.pixel);c.moveMap(a)},0,!1)),c.$apply(function(){c.feature=e,c.popupVisible=d})}},post:function(a){a.map.on("click",a.handleClick,this),a.popup=new ol.Overlay(a.overlayOptions),a.map.addOverlay(a.popup)}},controller:["$scope","$element","$attrs",function(a){a.calculatePopupExtent=function(b){var c,d,e=[5,5,5,5],f=a.popup.getOffset(),g=b[0]+f[0],h=b[1]+f[1],i=a.popupOuterWidth(),j=a.popupOuterHeight(),k=a.popup.getPositioning().split("-");switch(k[1]){case"left":c=g,d=g+i;break;case"center":c=g-i/2,d=g+i/2;break;case"right":c=g-i,d=g}c-=e[0],d+=e[2];var l,m;switch(k[0]){case"top":l=h,m=h+j;break;case"center":l=h-j/2,m=h+j/2;break;case"bottom":l=h-j,m=h}m+=e[1],l-=e[3];var n=[],o=a.map.getCoordinateFromPixel([c,m]),p=a.map.getCoordinateFromPixel([d,l]);return n=n.concat(o),n=n.concat(p)},a.moveMap=function(b){var c=a.map.getView(),d=c.calculateExtent(a.map.getSize()),e=0,f=0;if(b[0]<d[0]?e=b[0]-d[0]:b[2]>d[2]&&(e=b[2]-d[2]),b[1]<d[1]?f=b[1]-d[1]:b[3]>d[3]&&(f=b[3]-d[3]),0!==e||0!==f){var g=c.getCenter();c.setCenter([g[0]+e,g[1]+f])}},a.popupOuterHeight=function(){var b=angular.element(a.popup.getElement()),c=b.css("padding-top"),d=b.css("padding-bottom");return c=parseInt(c.slice(0,c.length-2)),d=parseInt(d.slice(0,d.length-2)),b.height()+c+d},a.popupOuterWidth=function(){var b=angular.element(a.popup.getElement()),c=b.css("padding-left"),d=b.css("padding-right");return c=parseInt(c.slice(0,c.length-2)),d=parseInt(d.slice(0,d.length-2)),b.width()+c+d},a.popupInnerHeight=function(){var b=angular.element(a.popup.getElement());return b.height()},a.popupInnerWidth=function(){var b=angular.element(a.popup.getElement());return b.width()}}]}}]),angular.module("anol.layerswitcher").directive("anolLayerswitcher",["LayersService",function(a){return{restrict:"A",require:"?^anolMap",transclude:!0,templateUrl:"src/modules/layerswitcher/templates/layerswitcher.html",scope:{anolLayerswitcher:"@anolLayerswitcher"},link:{pre:function(b,c,d,e){b.collapsed=!1,b.showToggle=!1,b.backgroundLayers=a.backgroundLayers;var f=[];angular.forEach(a.overlayLayers,function(a){a.get("displayInLayerswitcher")!==!1&&f.push(a)}),b.overlayLayers=f,angular.isDefined(e)&&(b.collapsed="open"!==b.anolLayerswitcher,b.showToggle=!0,c.addClass("ol-unselectable"),e.getMap().addControl(new ol.control.Control({element:c.first().context})))},post:function(a){angular.forEach(a.backgroundLayers,function(b){b.getVisible()===!0&&void 0===a.backgroundLayer?(a.backgroundLayer=b,a.backgroundLayer.setVisible(!1)):b.setVisible(!1)}),a.$watch("backgroundLayer",function(a,b){b.setVisible(!1),a.setVisible(!0)})}}}}]),angular.module("anol.map").provider("ControlsService",[function(){var a;this.setControls=function(b){a=b},this.$get=[function(){var b=function(a){this.controls=a||ol.control.defaults(),this.map=void 0};return b.prototype.registerMap=function(a){this.map=a},b.prototype.addControl=function(a){void 0!==this.map&&this.map.addControl(a),this.controls.push(a)},b.prototype.addControls=function(a){var b=this;void 0!==this.map&&angular.forEach(a,function(a){b.map.addControl(a)}),this.controls=this.controls.concat(a)},new b(a)}]}]),angular.module("anol.map").provider("InteractionsService",[function(){var a;this.setInteractions=function(b){a=b},this.$get=[function(){var b=function(a){this.interactions=a||ol.interaction.defaults(),this.map=void 0};return b.prototype.registerMap=function(a){this.map=a},b.prototype.addInteraction=function(a){void 0!==this.map&&this.map.addInteraction(a),this.interactions.push(a)},b.prototype.addInteractions=function(a){var b=this;void 0!==this.map&&angular.forEach(a,function(a){b.map.addInteraction(a)}),this.interactions=this.interactions.concat(a)},b.prototype.removeInteraction=function(a){this.map.removeInteraction(a);var b=$.inArray(this.interactions,a);-1!==b&&this.interactions.splice(b,1)},new b(a)}]}]),angular.module("anol.map").provider("LayersFactory",[function(){var a=this,b=function(a){var b={};return void 0!==a.projection&&(b.projection=a.projection),void 0!==a.attributions&&(a.attributions instanceof Array||(a.attributions=[a.attributions]),b.attributions=[],angular.forEach(a.attributions,function(a){b.attributions.push(new ol.Attribution({html:a}))})),b},c=function(a,b){return void 0!==b.title&&a.set("title",b.title),void 0!==b.shortcut&&a.set("shortcut",b.shortcut),void 0!==b.visible&&a.setVisible(b.visible),void 0!==b.extent&&a.setExtent(b.extent),void 0!==b.displayInLayerswitcher&&a.set("displayInLayerswitcher",b.displayInLayerswitcher),void 0!==b.isBackground&&a.set("isBackground",b.isBackground),void 0!==b.layer&&a.set("layer",b.layer),void 0!==b.style&&a.setStyle(b.style),a};this.newTMS=function(a){var d=!1,e=function(b){var c="";return b[1]>=0&&b[2]>=0&&(c+=a.baseURL+"/",c+=a.layer+"/",c+=b[0].toString()+"/",c+=b[1].toString()+"/",c+=b[2].toString(),c+="."+a.format),c};a.extent&&a.resolutions&&(d=new ol.tilegrid.TileGrid({origin:[a.extent[0],a.extent[1]],resolutions:a.resolutions}));var f=b(a);f.tileUrlFunction=e,d&&(f.tileGrid=d);var g=new ol.layer.Tile({source:new ol.source.TileImage(f)});return c(g,a)},this.newDynamicGeoJSON=function(a){var d,e=function(b,c,e){var f=["srs="+e.getCode(),"bbox="+b.join(",")];angular.isFunction(a.additionalParameters)&&f.push(a.additionalParameters());var g=a.url+f.join("&");$.ajax({url:g,dataType:"json"}).done(function(a){for(var b=d.getFeatures(),c=0;c<b.length;c++)d.removeFeature(b[c]);d.addFeatures(d.readFeatures(a)),d.dispatchEvent("anolSourceUpdated")})},f=b(a);f.format=new ol.format.GeoJSON,f.strategy=ol.loadingstrategy.bbox,f.loader=e,d=new ol.source.ServerVector(f);var g=new ol.layer.Vector({source:d});return c(g,a)},this.newGeoJSON=function(a){var d=b(a);d.url=a.url;var e=new ol.source.GeoJSON(d),f=new ol.layer.Vector({source:e});return c(f,a)},this.newSingleTileWMS=function(a){var d=b(a);d.url=a.url,d.params=a.params;var e=new ol.layer.Image({source:new ol.source.ImageWMS(d)});return c(e,a)},this.newFeatureLayer=function(a){var d=b(a),e=new ol.layer.Vector({source:new ol.source.Vector(d)});return c(e,a)},this.$get=[function(){return a}]}]),angular.module("anol.map").provider("LayersService",[function(){var a=[];this.setLayers=function(b){a=a.concat(b)},this.$get=[function(){var b=function(a){this.map=void 0,this.layers=[],this.backgroundLayers=[],this.overlayLayers=[],this.visibleLayerShortcuts=[],this.shortcutMapping={},this.addLayers(a)};return b.prototype.registerMap=function(a){this.map=a},b.prototype.prepareLayers=function(a,b){var c=this;angular.forEach(a,function(a){var d=a.get("shortcut");void 0!==d&&(c.shortcutMapping[d]=a,a.getVisible()&&c.visibleLayerShortcuts.push(d)),a.get("isBackground")?c.backgroundLayers.push(a):c.overlayLayers.push(a),a.on("change:visible",b),void 0!==c.map&&c.map.addLayer(a)})},b.prototype.visibleChangedHandler=function(a){var b=a.target,c=b.get("shortcut");if(void 0!==c){var d=$.inArray(c,this.visibleLayerShortcuts),e=b.getVisible();e&&-1==d?this.visibleLayerShortcuts.push(c):e||-1==d||this.visibleLayerShortcuts.splice(d,1)}},b.prototype.addLayer=function(a){var b=this;this.prepareLayers([a],function(a){b.visibleChangedHandler(a)}),this.layers.push(a)},b.prototype.addLayers=function(a){var b=this;this.prepareLayers(a,function(a){b.visibleChangedHandler(a)}),this.layers=this.layers.concat(a)},b.prototype.setVisibleByShortcuts=function(a){var b=this;a=a.split(""),angular.forEach(a,function(a){void 0!==b.shortcutMapping[a]&&b.shortcutMapping[a].setVisible(!0)});var c=$.grep(b.visibleLayerShortcuts,function(b){return-1==$.inArray(b,a)});angular.forEach(c,function(a){void 0!==b.shortcutMapping[a]&&b.shortcutMapping[a].setVisible(!1)})},b.prototype.backgroundLayer=function(){var a;return angular.forEach(this.backgroundLayers,function(b){b.getVisible()===!0&&(a=b)}),a},b.prototype.layersByProperty=function(a,b){var c=this,d=[];return angular.forEach(c.layers,function(c){c.get(a)===b&&d.push(c)}),d},new b(a)}]}]),angular.module("anol.map").directive("anolMap",["DefaultMapName","MapService",function(a,b){return{scope:{autoResize:"@autoResize"},link:{pre:function(c,d){c.mapName=a,c.map=b.getMap(),c.setContainerHeight=function(a){d.css("height",a),c.map.updateSize()}},post:function(a,b,c){b.attr("id",a.mapName).addClass(a.mapName),a.map.setTarget(a.mapName),("height"===c.autoResize||"both"===c.autoResize)&&a.$watch(function(){return window.innerHeight},function(c){if(void 0!==c){var d=b.css("margin-top");d=parseInt(d.slice(0,d.length-2));var e=b.css("margin-bottom");e=parseInt(e.slice(0,e.length-2)),a.setContainerHeight(c-d-e-4)}})}},controller:["$scope","$element","$attrs",function(a){this.getMap=function(){return a.map}}]}}]),angular.module("anol.map").provider("MapService",[function(){var a,b=function(b,c,d){var e=new ol.Map(angular.extend({},{controls:c,interactions:d,layers:b,logo:!1}));return e.setView(a),e};this.addView=function(b){a=b},this.$get=["LayersService","ControlsService","InteractionsService",function(a,c,d){var e=function(){this.map=void 0};return e.prototype.getMap=function(){return angular.isUndefined(this.map)&&(this.map=b(a.layers,c.controls,d.interactions),a.registerMap(this.map),c.registerMap(this.map),d.registerMap(this.map)),this.map},new e}]}]),angular.module("anol.mouseposition").directive("anolMousePosition",["MapService",function(a){return{restrict:"A",require:"?^anolMap",scope:{},link:{pre:function(b){b.map=a.getMap()},post:function(a,b,c,d){var e={};angular.isFunction(a.coordinateFormat)&&(e.coordinateFormat=a.coordinateFormat),angular.isUndefined(d)&&(e={target:b[0]}),a.map.addControl(new ol.control.MousePosition(e))}}}}]),angular.module("anol.permalink").provider("PermalinkService",[function(){var a,b=1e5,c=function(a){var b=/.*map=(\d+)\/(\d+\.?\d+?)\/(\d+\.?\d+?)\/(EPSG:\d+)\/?([A-Z]+)?$/g,c=b.exec(a);return null!==c&&6==c.length?{zoom:parseInt(c[1]),center:[parseFloat(c[2]),parseFloat(c[3])],crs:c[4],shortcuts:c[5]}:!1};this.setUrlCrs=function(b){a=b},this.setPrecision=function(a){b=a},this.$get=["$rootScope","$location","MapService","LayersService",function(d,e,f,g){var h=function(a,b){var h=this;h.urlCrs=a,h.precision=b,h.zoom=void 0,h.lon=void 0,h.lat=void 0,h.layersShortcuts=void 0,h.map=f.getMap(),h.view=h.map.getView(),h.map.on("moveend",h.moveendHandler,h),d.$watchCollection(function(){return g.visibleLayerShortcuts},function(a){void 0!==a&&(h.layersShortcuts=a.join(""),h.generatePermalink())});var i=c(e.path());if(i!==!1){var j=ol.proj.transform(i.center,i.crs,h.view.getProjection());h.view.setCenter(j),h.view.setZoom(i.zoom),void 0!==i.shortcuts&&g.setVisibleByShortcuts(i.shortcuts)}};return h.prototype.moveendHandler=function(){var a=this,b=ol.proj.transform(a.view.getCenter(),a.view.getProjection(),a.urlCrs);a.lon=Math.round(b[0]*this.precision)/this.precision,a.lat=Math.round(b[1]*this.precision)/this.precision,a.zoom=a.view.getZoom(),d.$apply(function(){a.generatePermalink()})},h.prototype.generatePermalink=function(){var a=this;if(void 0!==a.zoom&&void 0!==a.lon&&void 0!==a.lat){var b="map="+[a.zoom,a.lon,a.lat,a.urlCrs,a.layersShortcuts].join("/");e.path(b),a.permalink=e.absUrl()}},new h(a,b)}]}]),angular.module("anol.print").provider("PrintPageService",[function(){var a,b,c,d;this.setPageSizes=function(b){a=b},this.setOutputFormats=function(a){b=a},this.setDefaultScale=function(a){c=a},this.setStyle=function(a){d=a},this.$get=["$rootScope","MapService","LayersService","LayersFactory","InteractionsService",function(e,f,g,h,i){var j,k,l={top:void 0,lefttop:void 0,left:void 0,leftbottom:void 0,bottom:void 0,rightbottom:void 0,right:void 0,righttop:void 0,center:void 0},m=new ol.Collection,n={title:"PrintLayer",displayInLayerswitcher:!1};d&&(n.style=d);var o=h.newFeatureLayer(n),p=o.getSource();g.addLayer(o);var q=function(a,b,c){this.pageSizes=a,this.outputFormats=b,this.defaultScale=c,this.currentPageSize=void 0,this.currentScale=void 0};return q.prototype.createPrintArea=function(a,b,c){this.currentPageSize=a,this.currentScale=b,this.mapWidth=this.currentPageSize[0]/1e3*this.currentScale,this.mapHeight=this.currentPageSize[1]/1e3*this.currentScale;var d=f.getMap().getView();c=c||d.getCenter();var e=c[1]+this.mapHeight/2,g=c[1]-this.mapHeight/2,h=c[0]-this.mapWidth/2,i=c[0]+this.mapWidth/2;p.clear(),k=void 0,this.updatePrintArea(h,e,i,g),this.createDragFeatures(h,e,i,g,c)},q.prototype.createDragFeatures=function(a,b,c,e,f){m.clear(),l.left=new ol.Feature(new ol.geom.Point([a,f[1]])),l.left.set("position","left"),l.left.on("change",this.dragFeatureNormalChangeHandler,this),m.push(l.left),l.right=new ol.Feature(new ol.geom.Point([c,f[1]])),l.right.set("position","right"),l.right.on("change",this.dragFeatureNormalChangeHandler,this),m.push(l.right),l.top=new ol.Feature(new ol.geom.Point([f[0],b])),l.top.set("position","top"),l.top.on("change",this.dragFeatureNormalChangeHandler,this),m.push(l.top),l.bottom=new ol.Feature(new ol.geom.Point([f[0],e])),l.bottom.set("position","bottom"),l.bottom.on("change",this.dragFeatureNormalChangeHandler,this),m.push(l.bottom),l.leftbottom=new ol.Feature(new ol.geom.Point([a,e])),l.leftbottom.set("position","leftbottom"),l.leftbottom.on("change",this.dragFeatureDiagonalChangeHandler,this),m.push(l.leftbottom),l.lefttop=new ol.Feature(new ol.geom.Point([a,b])),l.lefttop.set("position","lefttop"),l.lefttop.on("change",this.dragFeatureDiagonalChangeHandler,this),m.push(l.lefttop),l.rightbottom=new ol.Feature(new ol.geom.Point([c,e])),l.rightbottom.set("position","rightbottom"),l.rightbottom.on("change",this.dragFeatureDiagonalChangeHandler,this),m.push(l.rightbottom),l.righttop=new ol.Feature(new ol.geom.Point([c,b])),l.righttop.set("position","righttop"),l.righttop.on("change",this.dragFeatureDiagonalChangeHandler,this),m.push(l.righttop),l.center=new ol.Feature(new ol.geom.Point(f)),l.center.set("position","center"),l.center.on("change",this.dragFeatureCenterChangeHandler,this),m.push(l.center),p.addFeatures(m.getArray()),void 0!==j&&i.removeInteraction(j);var g={features:m};void 0!==d&&(g.style=d),j=new ol.interaction.Modify(g),i.addInteraction(j)},q.prototype.updateDragFeatures=function(a){var b=this,c=k.getGeometry().getCoordinates()[0],d=c[0][0],e=c[1][0],f=c[0][1],g=c[2][1],h=k.getGeometry().getInteriorPoint().getCoordinates(),i=function(a,c,d,e){a.un("change",e,b),a!==c&&(m.remove(a),a.getGeometry().setCoordinates(d),m.push(a)),a.on("change",e,b)};i(l.left,a,[d,h[1]],this.dragFeatureNormalChangeHandler),i(l.bottom,a,[h[0],g],this.dragFeatureNormalChangeHandler),i(l.right,a,[e,h[1]],this.dragFeatureNormalChangeHandler),i(l.top,a,[h[0],f],this.dragFeatureNormalChangeHandler),i(l.leftbottom,a,[d,g],this.dragFeatureDiagonalChangeHandler),i(l.rightbottom,a,[e,g],this.dragFeatureDiagonalChangeHandler),i(l.righttop,a,[e,f],this.dragFeatureDiagonalChangeHandler),i(l.lefttop,a,[d,f],this.dragFeatureDiagonalChangeHandler),i(l.center,a,h,this.dragFeatureCenterChangeHandler)},q.prototype.dragFeatureNormalChangeHandler=function(a){var b=a.target;this.updatePrintAreaNormal(),this.updateDragFeatures(b),this.updatePrintSize()},q.prototype.dragFeatureDiagonalChangeHandler=function(a){var b=a.target;this.updatePrintAreaDiagonal(b),this.updateDragFeatures(b),this.updatePrintSize()},q.prototype.dragFeatureCenterChangeHandler=function(a){var b=a.target;this.updatePrintAreaCenter(b),this.updateDragFeatures(b)},q.prototype.updatePrintAreaDiagonal=function(a){var b,c,d,e;l.lefttop===a||l.rightbottom===a?(b=l.lefttop.getGeometry().getCoordinates(),e=l.rightbottom.getGeometry().getCoordinates(),this.updatePrintArea(b[0],b[1],e[0],e[1])):(c=l.righttop.getGeometry().getCoordinates(),d=l.leftbottom.getGeometry().getCoordinates(),this.updatePrintArea(d[0],c[1],c[0],d[1]))},q.prototype.updatePrintAreaNormal=function(){var a=l.left.getGeometry().getCoordinates()[0],b=l.right.getGeometry().getCoordinates()[0],c=l.top.getGeometry().getCoordinates()[1],d=l.bottom.getGeometry().getCoordinates()[1];this.updatePrintArea(a,c,b,d)},q.prototype.updatePrintAreaCenter=function(a){var b=a.getGeometry().getCoordinates(),c=b[1]+this.mapHeight/2,d=b[1]-this.mapHeight/2,e=b[0]-this.mapWidth/2,f=b[0]+this.mapWidth/2;this.updatePrintArea(e,c,f,d)},q.prototype.updatePrintArea=function(a,b,c,d){var e=[[[a,b],[c,b],[c,d],[a,d],[a,b]]];void 0!==k&&p.removeFeature(k),k=new ol.Feature(new ol.geom.Polygon(e)),p.addFeatures([k])},q.prototype.updatePrintSize=function(){var a=this;e.$apply(function(){a.mapWidth=l.right.getGeometry().getCoordinates()[0]-l.left.getGeometry().getCoordinates()[0],a.mapHeight=l.top.getGeometry().getCoordinates()[1]-l.bottom.getGeometry().getCoordinates()[1],a.currentPageSize=[1e3*a.mapWidth/a.currentScale,1e3*a.mapHeight/a.currentScale]})},q.prototype.addFeatureFromPageSize=function(a,b){void 0===k?this.createPrintArea(a,b):this.createPrintArea(a,b,k.getGeometry().getInteriorPoint().getCoordinates())},q.prototype.getBounds=function(){var a=[];return a=a.concat(l.leftbottom.getGeometry().getCoordinates()),a=a.concat(l.righttop.getGeometry().getCoordinates())},q.prototype.visible=function(a){o.setVisible(a)},new q(a,b,c)}]}]),angular.module("anol.scale").directive("anolScaleLine",["MapService",function(a){return{restrict:"A",require:"?^anolMap",scope:{},link:{pre:function(b,c,d,e){b.map=a.getMap();var f={};angular.isUndefined(e)&&(f={target:c[0]}),b.map.addControl(new ol.control.ScaleLine(f))}}}}]),angular.module("anol.scale").constant("calculateScale",function(a){var b=1e3/25.4,c=72,d=a.getResolution(),e=a.getProjection().getMetersPerUnit(),f=d*e*b*c;return Math.round(f)}).directive("anolScaleText",["$timeout","MapService","calculateScale",function(a,b,c){return{restrict:"A",require:"?^anolMap",templateUrl:"src/modules/scale/templates/scaletext.html",scope:{},link:{pre:function(a,d,e,f){a.view=b.getMap().getView(),angular.isDefined(f)&&(d.addClass("ol-unselectable"),b.getMap().addControl(new ol.control.Control({element:d.first().context}))),a.scale=c(a.view)},post:function(b){b.view.on("change:resolution",function(){a(function(){b.scale=c(b.view)},0,!0)})}}}}]);